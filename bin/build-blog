#!/usr/bin/env node
var fs = require('fs')
var path = require('path')
var yaml = require('js-yaml')

const POSTS_DIR = path.join(process.env.PWD, 'posts')
const BLOG_MANIFEST = path.join(process.env.PWD, 'assets', 'blog-manifest.js')

function getRawPosts() {
  const postFiles = fs.readdirSync(POSTS_DIR)
  return postFiles.map(file => {
    const filePath = path.join(POSTS_DIR, file)
    const rawFileString = fs.readFileSync(filePath, 'utf8')
    return parsePost(rawFileString)
  })
}

// Convert post.md file to object { date, markdown, title, tags }
function parsePost(rawString) {
  const splitContent = rawString.split("----\n")
  const data = yaml.safeLoad(splitContent[0])
  const tags = Object.assign(...data.tags.split(',').map(k => ({ [k]: true })))
  console.log(data)
  return {
    ...data,
    tags,
    markdown: splitContent.slice(1).join('')
  }
}

console.log('Begin building blog from /posts folder.')
const startTime = new Date()

console.log('Retrieving and building posts...')
const posts = getRawPosts()

console.log(`Writing manifest (${posts.length} posts)...`)
fs.writeFileSync(BLOG_MANIFEST, `const postJSON = ${JSON.stringify(posts)};\nexport default postJSON`)

console.log(`âœ¨  Done in ${new Date() - startTime} ms`)
